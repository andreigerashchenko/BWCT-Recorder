<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWCT Recording Device Control</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css')  }}">
</head>

<body>
    <h1 class="text-center">BWCT Recording Device Control</h1>
    <div class="d-flex justify-content-center mt-3">
        <button type="button" id="recordButton" class="btn btn-success mx-2" onclick="toggleRecording()">Start
            Recording</button>
    </div>
    <div class="d-flex justify-content-center mt-2">
        <p id="camera" class="mx-1">Using day camera</p>
        <p> | </p>
        <p id="status" class="mx-1">Not recording</p>
    </div>
    <div class="d-flex justify-content-center">
        <img src="/video_feed" style="max-width: 100%;">
    </div>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js')  }}"></script>
    <script>
        var isRecording = false;

        var state = {
            should_record: false,
            recording: false,
            recording_start_time: null,
            recording_directory: null,
            recording_duration: null,
            recording_name: null,
            combining: false,
            night: false,
            error: undefined,
        }

        function updateState(data) {
            state.should_record = data.should_record;
            state.recording = data.recording;
            state.recording_start_time = data.recording_start_time;
            state.recording_directory = data.recording_directory;
            state.recording_duration = data.recording_duration;
            state.recording_name = data.recording_name;
            state.combining = data.combining;
            state.night = data.night;
            state.error = data.error;
        }

        function toggleRecording() {
            if (!state.should_record) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            // send request to /start_recording
            fetch('/start_recording')
                .then(response => response.json())
                .then(data => {
                    updateState(data);
                })
                .catch(error => {
                    console.error(error);
                });
            updateUI();
        }

        function stopRecording() {
            // send request to /stop_recording
            fetch('/stop_recording')
                .then(response => response.json())
                .then(data => {
                    updateState(data);
                })
                .catch(error => {
                    console.error(error);
                });
            updateUI();
        }

        function timeString(duration) {
            // let difference = Date.now() / 1000 - state.recording_start_time;
            let difference = duration;
            // Days if difference is greater than 1 day
            let days = difference > 86400 ? Math.floor(difference / 86400) : 0;
            // Hours if difference is greater than 1 hour
            let hours = difference > 3600 ? Math.floor((difference % 86400) / 3600) : 0;
            // Minutes if difference is greater than 1 minute
            let minutes = difference > 60 ? Math.floor((difference % 3600) / 60) : 0;
            // Seconds
            let seconds = Math.floor(difference % 60);
            // Return formatted string
            return `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
        }

        function updateUI() {
            // get information from /status
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    updateState(data);
                })
                .catch(error => {
                    console.error(error);
                });

            var button = document.getElementById("recordButton");
            button.innerHTML = state.should_record ? "Stop Recording" : "Start Recording";

            if (state.recording) {
                // calculate time since recording started
                // let duration = new Date() - new Date(state.recording_start_time);
                // fill in duration
                // document.getElementById("status").innerHTML = `Recording for: ${timeString(duration)}`;
                document.getElementById("status").innerHTML = `Recording for: ${timeString(state.recording_duration)}`;
            }
            if (state.combining) {
                document.getElementById("status").innerHTML = "Combining segments, please wait...";
            }
            if (!state.recording && !state.combining) {
                document.getElementById("status").innerHTML = "Not recording";
            }
            
            if (state.night) {
                document.getElementById("camera").innerHTML = "Using night camera";
            } else {
                document.getElementById("camera").innerHTML = "Using day camera";
            }

            if (state.error != undefined) {
                document.getElementById("status").innerHTML = state.error;
            }
        }


        // update UI every 0.5 seconds
        setInterval(updateUI, 500);
    </script>
</body>

</html>